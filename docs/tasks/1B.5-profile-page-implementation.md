# Task 1B.5: Profile Page Implementation

## Goal
Implement a fully functional profile page where users can update their personal information, upload a profile picture, and manage their email address.

## Requirements

1.  **Profile Image Upload**: Allow users to upload a new avatar image.
2.  **Basic Info Update**: Allow users to update their "Name" and "Bio".
3.  **Email Update**: Allow users to change their email address, triggering a verification flow.

## Implementation Steps & Hints

### 1. Database Schema Updates (`db/migrations/`)
You'll need to store the new fields. The `users` table currently might only have basic GitHub info.

*   **Migration**: Create a new migration (e.g., `003_add_profile_fields.sql`) to add:
    *   `bio` (TEXT)
    *   `avatar_local_path` (TEXT) - to store the path of uploaded images.
    *   `email_new` (TEXT) - to store the pending email address.
    *   `email_verification_token` (TEXT)
    *   `email_verification_sent_at` (TIMESTAMPTZ)

### 2. SQL Queries (`db/queries/users.sql`)
Update your SQLC queries to support these operations.

*   **Hint**: You'll need a query like `UpdateUserProfile` that updates name and bio.
*   **Hint**: A separate query `UpdateUserAvatar` might be cleaner.
*   **Hint**: For email, `InitiateEmailChange` (sets `email_new` and token) and `CompleteEmailChange` (moves `email_new` to `email` and clears token).

### 3. Backend Logic (`internal/web/handlers/profile.go`)

#### A. Profile Image Upload
*   **Echo Context**: Use `c.FormFile("avatar")` to get the file.
*   **Storage**: Save the file to a public directory (e.g., `public/uploads/avatars/{user_id}.jpg`).
    *   *Tip*: Ensure the directory exists using `os.MkdirAll`.
*   **Database**: Update the user's record with the new file path.
*   **Session**: Don't forget to update the session if the avatar URL changes!

#### B. Bio & Name Update
*   **Form Handling**: You can use standard form submission or Datastar.
*   **Validation**: Ensure the name isn't empty. Bio might have a max length.

#### C. Email Verification (Mock for now)
*   **Flow**:
    1.  User submits new email.
    2.  Generate a random token (crypto/rand).
    3.  Save to DB.
    4.  "Send" email (just log the verification link to the console for now).
    5.  Create a new route `GET /verify-email?token=...` to handle the click.

### 4. Frontend (`internal/web/templates/pages/profile.templ`)

#### File Upload Form
*   **Enctype**: Remember to set `enctype="multipart/form-data"` on the form tag if you are doing a standard POST.
*   **Preview**: (Optional) Use a little JavaScript to show the selected image before uploading.

```html
<!-- Example Hint -->
<form action="/admin/profile/avatar" method="POST" enctype="multipart/form-data">
    <input type="file" name="avatar" accept="image/*" />
    <button type="submit">Upload</button>
</form>
```

#### Email Verification UI
*   Show a "Pending Verification" badge if `email_new` is set in the DB.
*   Disable the email input or show a warning that changing it requires re-verification.

## Resources
*   **Echo File Uploads**: [Echo Guide](https://echo.labstack.com/guide/request/#form-file)
*   **SQLC**: Run `yarn sqlc` after changing `.sql` files.
*   **Shoelace**: Use `<sl-input>`, `<sl-textarea>`, and `<sl-avatar>` components.

## "Definition of Done"
*   [ ] Can upload an image and see it persist after refresh.
*   [ ] Can update Name/Bio and see changes.
*   [ ] Can change email, see "verification link" in logs, click it, and see email updated.
