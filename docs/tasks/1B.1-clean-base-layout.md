# Task 1B.1: Clean Base Layout

## Goal
Refactor the layout to have a proper structure with header, navigation, main content, and footer.
**With HTMX + View Transitions for smooth, SPA-like navigation.**

## Tech Stack Reminder
- **Templ**: Type-safe HTML components
- **HTMX**: AJAX navigation without writing JS
- **Shoelace**: Web components for UI elements
- **View Transitions API**: Smooth page transitions

## Current State
- `Layout` - basic wrapper with footer
- `AuthedLayout` - adds inline nav for authenticated users
- No proper header component
- Navigation is inside `AuthedLayout` only
- Has `hx-boost` but not fully structured

## Target State
```
┌─────────────────────────────────────┐
│ Header (logo, nav) [hx-preserve]    │
├─────────────────────────────────────┤
│                                     │
│ Main Content [view-transition]      │
│                                     │
├─────────────────────────────────────┤
│ Footer [hx-preserve]                │
└─────────────────────────────────────┘
│ Persistent Layer [hx-preserve]      │  ← Toasts, modals, audio, etc.
└─────────────────────────────────────┘
```

## Key HTMX Concepts

### `hx-boost="true"`
Converts regular links to AJAX requests. The response replaces part of the page.

### `hx-swap="innerHTML transition:true"`
- `innerHTML`: Replace inner content of target
- `transition:true`: Enable View Transitions API

### `hx-preserve="true"`
Keep this element alive across page navigations (useful for header, footer, status).

### `hx-push-url="true"`
Update browser URL after AJAX navigation (already implied by hx-boost).

## Your Task

### Step 1: Create a Header component
Create a new file: `internal/web/templates/components/header.templ`

```templ
package components

import "github.com/gracchi-stdio/goaat/internal/auth"

// Header renders the site header with navigation
// Uses hx-preserve to stay consistent across HTMX navigations
templ Header() {
    <header class="site-header" hx-preserve="true">
        <div class="header-content">
            <a href="/" class="logo">
                <sl-icon name="box"></sl-icon>
                Goaat
            </a>
            <nav class="main-nav">
                @Nav()
            </nav>
        </div>
    </header>
}

// Nav renders navigation links based on auth state
templ Nav() {
    <ul class="nav-list">
        <li><a href="/">Home</a></li>
        if auth.GetUserFromContext(ctx).IsAuthenticated() {
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/profile">Profile</a></li>
            <li>
                <sl-button size="small" variant="text" hx-post="/logout" hx-swap="none">
                    Logout
                </sl-button>
            </li>
        } else {
            <li><a href="/login">Login</a></li>
        }
    </ul>
}
```

**What you'll learn:**
- Creating a new Templ component
- Conditional rendering with `if`
- Accessing auth context in templates
- HTMX attributes for logout (no page reload)

### Step 2: Create a Footer component
Create: `internal/web/templates/components/footer.templ`

```templ
package components

templ Footer() {
    <footer class="site-footer" hx-preserve="true">
        <p>&copy; 2025 Goaat - Built with Echo, Templ & PostgreSQL</p>
    </footer>
}
```

### Step 3: Create a Persistent Layer component
Create: `internal/web/templates/components/persistent.templ`

This layer stays alive across all navigations. Use it for:
- Toast notifications
- Modal dialogs
- Audio/video players
- Global loading indicators
- Connection status

```templ
package components

// PersistentLayer contains UI elements that survive page navigations
// Examples: toasts, modals, audio players, global status
templ PersistentLayer() {
    <div id="persistent-layer" hx-preserve="true">
        // Toast container - notifications will be injected here via HTMX
        <div id="toast-container" class="toast-container">
            // Toasts appear here dynamically
        </div>
        
        // Modal container - for dialogs that shouldn't close on navigation
        <div id="modal-container">
            // Modals can be swapped here
        </div>
        
        // Global loading indicator (hidden by default)
        <div id="global-loader" class="global-loader htmx-indicator">
            <sl-spinner></sl-spinner>
        </div>
        
        // Connection status (example of persistent UI)
        <div id="connection-status" class="connection-status">
            <sl-badge variant="success" pill>
                <sl-icon name="wifi"></sl-icon>
                Online
            </sl-badge>
        </div>
    </div>
}
```

**What you'll learn:**
- Persistent UI patterns with HTMX
- Container elements for dynamic content injection
- `htmx-indicator` class for loading states

### Step 4: Update Layout to use components
Modify `internal/web/templates/layouts/layout.templ`:

```templ
package layouts

import (
    "os"
    "github.com/gracchi-stdio/goaat/internal/web/templates/components"
)

templ Layout(title string, class string) {
    <!DOCTYPE html>
    <html lang="en" class="sl-theme-dark">
        <head>
            <meta charset="UTF-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
            <title>{ title } - Goaat</title>
            if os.Getenv("ENV") == "development" {
                <script type="module" src="http://localhost:5173/@vite/client"></script>
                <link rel="stylesheet" href="http://localhost:5173/assets/css/main.css"/>
                <script type="module" src="http://localhost:5173/assets/js/main.js"></script>
            } else {
                <link rel="stylesheet" href="/css/main.css"/>
                <script type="module" src="/js/main.js"></script>
            }
        </head>
        <body class={ class } hx-boost="true" hx-indicator="#global-loader">
            @components.Header()
            
            // Main content area - this is what gets swapped on navigation
            <main id="main-content" class="site-main" hx-swap="innerHTML transition:true">
                { children... }
            </main>
            
            @components.Footer()
            
            // Persistent layer - survives all navigations
            @components.PersistentLayer()
        </body>
    </html>
}

// AuthedLayout is now simpler - just uses Layout
// The nav already shows auth-specific links
templ AuthedLayout(title string, class string) {
    @Layout(title, class) {
        { children... }
    }
}
```

**What you'll learn:**
- Importing components from another package
- Component composition with `@componentName()`
- HTMX swap target setup

### Step 4: Add CSS for Layout
Update `assets/css/main.css` to add layout styles:

```css
/* Layout Structure */
body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    margin: 0;
}

.site-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--sl-color-neutral-50);
    border-bottom: 1px solid var(--sl-color-neutral-200);
}

.header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0.75rem 1.5rem;
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--sl-color-primary-600);
    text-decoration: none;
}

.nav-list {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
}

.nav-list a {
    color: var(--sl-color-neutral-700);
    text-decoration: none;
    transition: color 0.2s;
}

.nav-list a:hover {
    color: var(--sl-color-primary-600);
}

.site-main {
    flex: 1;
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    padding: 2rem 1.5rem;
}

.site-footer {
    background: var(--sl-color-neutral-100);
    text-align: center;
    padding: 1rem;
    color: var(--sl-color-neutral-600);
    font-size: 0.875rem;
}

/* View Transitions */
@view-transition {
    navigation: auto;
}

.site-main {
    view-transition-name: main-content;
}

@keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fade-out {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-10px); }
}

::view-transition-old(main-content) {
    animation: fade-out 0.15s ease-out;
}

::view-transition-new(main-content) {
    animation: fade-in 0.15s ease-in;
}

/* ================================
   Persistent Layer
   ================================ */

#persistent-layer {
    position: fixed;
    z-index: 1000;
    pointer-events: none; /* Allow clicks to pass through to content */
}

#persistent-layer > * {
    pointer-events: auto; /* But children are clickable */
}

/* Toast notifications - top right */
.toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-width: 400px;
}

/* Connection status - bottom right */
.connection-status {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
}

/* Global loader - center screen */
.global-loader {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: none; /* Hidden by default */
}

/* HTMX shows this during requests */
.global-loader.htmx-request {
    display: block;
}

/* Modal container - fullscreen overlay */
#modal-container:empty {
    display: none;
}

#modal-container {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.5);
}
```

### Step 6: Run and verify
```bash
# In the container, templ should auto-generate on save
# Or manually: templ generate

# Check for errors
go build ./...
```

## HTMX Behavior Summary

| Attribute | Where | Effect |
|-----------|-------|--------|
| `hx-boost="true"` | `<body>` | All links become AJAX |
| `hx-preserve="true"` | Header/Footer/Persistent | Don't replace on navigation |
| `hx-indicator="#global-loader"` | `<body>` | Show loader during any request |
| `hx-swap="innerHTML transition:true"` | `<main>` | Replace content with animation |
| `hx-post="/logout"` | Logout button | POST without full page load |

## Persistent Layer Use Cases

| Container | Purpose | How to Use |
|-----------|---------|------------|
| `#toast-container` | Notifications | `hx-swap-oob="beforeend:#toast-container"` |
| `#modal-container` | Dialogs | `hx-target="#modal-container"` |
| `#global-loader` | Loading | Automatic via `htmx-indicator` |
| `#connection-status` | System status | Update via WebSocket or polling |

### Example: Showing a Toast from Server
```go
// In a handler, return extra HTML to inject a toast
func (h *Handler) SaveFile(c echo.Context) error {
    // ... save logic ...
    
    // Return main response + OOB toast
    return c.HTML(200, `
        <div>File saved!</div>
        <sl-alert variant="success" open closable hx-swap-oob="beforeend:#toast-container">
            File saved successfully!
        </sl-alert>
    `)
}
```

## Questions to Think About
1. Why separate Header/Footer into their own files?
2. What's the difference between `@Component()` and `{ children... }`?
3. How does `hx-preserve` differ from just having static HTML?
4. Why use `view-transition-name` on `<main>`?
5. Why use `pointer-events: none` on the persistent layer?

## When You're Done
- [ ] Created `components/header.templ`
- [ ] Created `components/footer.templ`
- [ ] Created `components/persistent.templ`
- [ ] Updated `layouts/layout.templ`
- [ ] Added CSS layout styles (including persistent layer)
- [ ] App compiles and runs
- [ ] Header/footer appear on pages
- [ ] Navigation links work with smooth transitions
- [ ] Persistent layer is visible (connection status badge)

## Hints
- Templ files must have `.templ` extension
- After saving `.templ`, the `_templ.go` file is auto-generated
- If imports fail, check the package name matches the folder
- View Transitions need a modern browser (Chrome, Edge)
- The persistent layer uses `position: fixed` to float above content

---

Let me know when you're ready, or if you want me to do this one as a demo first!
